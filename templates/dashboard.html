<!DOCTYPE html>
<html>
<head>
    <title>Sensor Data Pipeline Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        h1 {
            font-size: 42px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            font-weight: 800;
            letter-spacing: -1px;
        }
        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 30px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        .card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 28px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 24px 70px rgba(96, 165, 250, 0.2);
        }
        .card h2 {
            font-size: 16px;
            margin-bottom: 20px;
            color: #60a5fa;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .stat {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        .stat:last-child { border-bottom: none; }
        .stat-label {
            color: #94a3b8;
            font-size: 14px;
        }
        .stat-value {
            color: #60a5fa;
            font-weight: 700;
            font-size: 18px;
        }
        .big-stat {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.1) 0%, rgba(167, 139, 250, 0.1) 100%);
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .big-stat-value {
            font-size: 56px;
            font-weight: 900;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        .big-stat-label {
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 12px;
            font-weight: 600;
        }
        button {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #1e293b;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
        }
        .btn-toggle {
            background: rgba(71, 85, 105, 0.5);
            color: white;
            padding: 10px 20px;
            font-size: 13px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        .btn-toggle.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: #3b82f6;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 16px;
        }
        input[type="number"] {
            padding: 14px 16px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
            font-size: 15px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        .input-wrapper {
            position: relative;
        }
        .input-label {
            position: absolute;
            top: -8px;
            left: 12px;
            background: rgba(30, 41, 59, 0.9);
            padding: 0 8px;
            color: #60a5fa;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        label {
            display: block;
            margin-bottom: 12px;
            color: #60a5fa;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-running {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }
        .status-stopped {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }
        .status-pending {
            background: #f59e0b;
            box-shadow: 0 0 10px #f59e0b;
        }
        .status-unknown {
            background: #64748b;
            box-shadow: 0 0 10px #64748b;
        }
        .history-container {
            max-height: 600px;
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            padding: 16px;
        }
        .history-container::-webkit-scrollbar {
            width: 8px;
        }
        .history-container::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.4);
            border-radius: 4px;
        }
        .history-container::-webkit-scrollbar-thumb {
            background: rgba(96, 165, 250, 0.5);
            border-radius: 4px;
        }
        .history-container::-webkit-scrollbar-thumb:hover {
            background: rgba(96, 165, 250, 0.7);
        }
        .history-item {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #60a5fa;
            transition: all 0.3s;
        }
        .history-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 20px rgba(96, 165, 250, 0.2);
        }
        .history-timestamp {
            color: #94a3b8;
            font-size: 11px;
            margin-bottom: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 14px;
        }
        .history-metric {
            text-align: center;
            padding: 12px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            border: 1px solid rgba(96, 165, 250, 0.1);
        }
        .history-metric.hidden {
            display: none;
        }
        .alert-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 360px;
            overflow-y: auto;
        }
        .alert-item {
            background: rgba(148, 163, 184, 0.08);
            border-radius: 12px;
            padding: 14px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            display: flex;
            justify-content: space-between;
            gap: 16px;
        }
        .alert-type {
            font-weight: 700;
            color: #f8fafc;
            font-size: 14px;
        }
        .alert-message {
            color: #cbd5f5;
            font-size: 13px;
            margin-top: 4px;
        }
        .alert-meta {
            text-align: right;
            font-size: 12px;
            color: #94a3b8;
        }
        .alert-badge {
            padding: 4px 12px;
            border-radius: 999px;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        .alert-badge.info { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        .alert-badge.warning { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
        .alert-badge.error { background: rgba(248, 113, 113, 0.15); color: #f87171; }
        .alert-badge.critical { background: rgba(248, 113, 113, 0.25); color: #fecaca; }
        .config-meta {
            margin-top: 12px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
            min-height: 16px;
        }
        .metric-value {
            font-size: 20px;
            font-weight: 900;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .metric-label {
            font-size: 10px;
            color: #94a3b8;
            margin-top: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        .toggles {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .preset-container {
            margin-top: 20px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            border: 1px solid rgba(96, 165, 250, 0.2);
        }
        .preset-title {
            color: #94a3b8;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            background: rgba(71, 85, 105, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #94a3b8;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .tab:hover {
            background: rgba(71, 85, 105, 0.5);
            border-color: rgba(96, 165, 250, 0.3);
        }
        .tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        .sensor-item {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(96, 165, 250, 0.1);
            transition: all 0.3s;
        }
        .sensor-item:hover {
            border-color: rgba(96, 165, 250, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(96, 165, 250, 0.1);
        }
        .sensor-name {
            color: #94a3b8;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .sensor-value {
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .sensor-unit {
            color: #94a3b8;
            font-size: 12px;
            margin-left: 4px;
        }
        .sensor-toggle {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        .sensor-toggle:hover {
            opacity: 1;
        }
        .sensor-item.hidden-sensor {
            opacity: 0.3;
            filter: grayscale(100%);
        }
        .sensor-item {
            position: relative;
        }
        .card-intro {
            font-size: 14px;
            color: #cbd5f5;
            margin-bottom: 16px;
            line-height: 1.5;
        }
        .hero-info {
            margin-bottom: 24px;
            border-radius: 18px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            background: rgba(15, 23, 42, 0.4);
            overflow: hidden;
        }
        .hero-info summary {
            list-style: none;
            cursor: pointer;
            padding: 18px 24px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: rgba(30, 41, 59, 0.7);
        }
        .hero-info summary::-webkit-details-marker {
            display: none;
        }
        .hero-info .chevron {
            transition: transform 0.3s;
            font-size: 18px;
        }
        .hero-info[open] .chevron {
            transform: rotate(180deg);
        }
        .hero-wrapper {
            padding: 20px;
        }
        .hero {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 32px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .hero h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #f8fafc;
        }
        .hero p {
            color: #cbd5f5;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .step-list {
            list-style: none;
            display: grid;
            gap: 10px;
        }
        .step-list li {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(96, 165, 250, 0.1);
            align-items: center;
        }
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
        }
        .pipeline-flow {
            display: flex;
            gap: 12px;
            align-items: stretch;
            flex-wrap: wrap;
        }
        .flow-node {
            flex: 1;
            min-width: 140px;
            padding: 12px;
            border-radius: 14px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(96, 165, 250, 0.1);
        }
        .flow-title {
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 6px;
        }
        .flow-text {
            font-size: 13px;
            color: #cbd5f5;
            line-height: 1.4;
        }
        .flow-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-weight: 700;
            font-size: 18px;
            min-width: 24px;
        }
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(96, 165, 250, 0.1);
            font-size: 13px;
            color: #cbd5f5;
        }
        .info-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 999px;
            border: 1px solid rgba(96, 165, 250, 0.2);
            font-size: 13px;
            background: rgba(96, 165, 250, 0.08);
            color: #cbd5f5;
            margin-top: 12px;
        }
        .hero-note {
            font-size: 13px;
            color: #94a3b8;
            line-height: 1.6;
        }

        /* ML Anomaly Detection Styles */
        .anomaly-item {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #ef4444;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            transition: all 0.3s;
        }
        .anomaly-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2);
        }
        .anomaly-info {
            flex: 1;
        }
        .anomaly-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .anomaly-score {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
        }
        .anomaly-method {
            color: #94a3b8;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .anomaly-timestamp {
            color: #60a5fa;
            font-size: 14px;
            font-weight: 600;
        }
        .anomaly-sensors {
            color: #cbd5e1;
            font-size: 13px;
            margin-top: 8px;
        }
        .anomaly-sensors span {
            display: inline-block;
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
            padding: 2px 8px;
            border-radius: 6px;
            margin-right: 6px;
            margin-top: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .anomaly-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .btn-report {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .btn-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        .btn-report:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-view-report {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .btn-view-report:hover {
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .report-status {
            font-size: 11px;
            color: #94a3b8;
            text-align: center;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: #1e293b;
            border-radius: 20px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid rgba(96, 165, 250, 0.2);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            background: rgba(15, 23, 42, 0.6);
        }
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #f8fafc;
        }
        .modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.3s;
        }
        .modal-close:hover {
            color: #ef4444;
        }
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 80px);
            color: #e2e8f0;
            line-height: 1.7;
        }
        .modal-body h3 {
            color: #60a5fa;
            margin-top: 24px;
            margin-bottom: 12px;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .modal-body h3:first-child {
            margin-top: 0;
        }
        .modal-body ul {
            margin-left: 20px;
            margin-bottom: 16px;
        }
        .modal-body li {
            margin-bottom: 8px;
        }
        .modal-body p {
            margin-bottom: 12px;
        }
        .report-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
        }
        .report-meta-item {
            text-align: center;
        }
        .report-meta-label {
            color: #94a3b8;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }
        .report-meta-value {
            color: #60a5fa;
            font-size: 18px;
            font-weight: 700;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Sensor Data Pipeline</h1>
        <div class="subtitle">Real-Time IoT Monitoring Dashboard</div>

        <details class="hero-info" id="onboardingDetails">
            <summary>
                <span>?? New to this dashboard? Click to learn how it works.</span>
                <span class="chevron">‚ñº</span>
            </summary>
            <div class="hero-wrapper">
                <div class="hero">
                    <div>
                        <h3>Quick start steps</h3>
                        <p>This panel lets you start, stop, and watch an entire demo factory pipeline. Follow the three quick steps below and the rest of the cards will begin to fill themselves in.</p>
                        <ul class="step-list">
                            <li>
                                <span class="step-number">1</span>
                                <div>
                                    <strong>Start the Consumer (Waiter)</strong>
                                    <div class="hero-note">It listens for new readings and writes them into PostgreSQL. Start this before anything else.</div>
                                </div>
                            </li>
                            <li>
                                <span class="step-number">2</span>
                                <div>
                                    <strong>Start the Producer (Data maker)</strong>
                                    <div class="hero-note">This generates pretend sensor readings and hands them to Kafka so the consumer has something to save.</div>
                                </div>
                            </li>
                            <li>
                                <span class="step-number">3</span>
                                <div>
                                    <strong>Watch the Status, Alerts, and Live Readings</strong>
                                    <div class="hero-note">Green dots mean the pieces are healthy. Any alert shows up in plain English so you know what needs attention.</div>
                                </div>
                            </li>
                        </ul>
                        <div class="info-pill">‚ú≥ Need a shortcut? Use the presets in the Configuration card and keep this page open to see everything update in real time.</div>
                    </div>
                    <div>
                        <h3>What is happening end-to-end?</h3>
                        <div class="pipeline-flow" aria-label="Pipeline overview">
                            <div class="flow-node">
                                <div class="flow-title">Producer</div>
                                <div class="flow-text">Creates fake machine readings based on the ranges in <code>config.py</code>.</div>
                            </div>
                            <div class="flow-arrow">‚Üí</div>
                            <div class="flow-node">
                                <div class="flow-title">Kafka</div>
                                <div class="flow-text">Acts like a conveyor belt. Messages queue here until the consumer grabs them.</div>
                            </div>
                            <div class="flow-arrow">‚Üí</div>
                            <div class="flow-node">
                                <div class="flow-title">Consumer</div>
                                <div class="flow-text">Validates each reading, flags anomalies, and writes everything to the database.</div>
                            </div>
                            <div class="flow-arrow">‚Üí</div>
                            <div class="flow-node">
                                <div class="flow-title">Database</div>
                                <div class="flow-text">Stores the official record shown in the stats, alerts, and history sections.</div>
                            </div>
                        </div>
                        <h3 style="margin-top: 20px;">What the colors mean</h3>
                        <div class="legend">
                            <div class="legend-item">
                                <span class="status-indicator status-running"></span>
                                Running and healthy
                            </div>
                            <div class="legend-item">
                                <span class="status-indicator status-stopped"></span>
                                Stopped or not reachable
                            </div>
                            <div class="legend-item">
                                <span class="status-indicator status-pending"></span>
                                Starting up / waiting on a reply
                            </div>
                            <div class="legend-item">
                                <span class="status-indicator status-unknown"></span>
                                Not checked yet (refreshing soon)
                            </div>
                        </div>
                        <div class="hero-note" style="margin-top: 16px;">Tip: If you forget what a section is for, read the short description right under each card heading.</div>
                    </div>
                </div>
            </div>
        </details>

        <div class="grid">
            <!-- Stats Card -->
            <div class="card">
                <h2>üìä Statistics</h2>
                <p class="card-intro">Shows how many readings have been saved and highlights the latest sensor values. If you just started the pipeline, this number will ramp up as messages flow through.</p>
                <div class="big-stat">
                    <div class="big-stat-value" id="totalCount">0</div>
                    <div class="big-stat-label">Total Messages</div>
                </div>
                <div class="tabs" id="statsCategoryTabs"></div>
                <div id="statsCategoryContent"></div>
            </div>

            <!-- Control Card -->
            <div class="card">
                <h2>‚öôÔ∏è Controls</h2>
                <p class="card-intro">Think of this as the on/off switchboard. Start the consumer first, then the producer. Stop buttons immediately send a shutdown signal to each Python process.</p>
                <div class="stat">
                    <span class="stat-label">
                        <span class="status-indicator" id="producerStatus"></span>
                        Producer
                    </span>
                </div>
                <div class="controls">
                    <button class="btn-success" onclick="startComponent('producer')">‚ñ∂ Start</button>
                    <button class="btn-danger" onclick="stopComponent('producer')">‚èπ Stop</button>
                </div>

                <div class="stat" style="margin-top: 20px;">
                    <span class="stat-label">
                        <span class="status-indicator" id="consumerStatus"></span>
                        Consumer
                    </span>
                </div>
                <div class="controls">
                    <button class="btn-success" onclick="startComponent('consumer')">‚ñ∂ Start</button>
                    <button class="btn-danger" onclick="stopComponent('consumer')">‚èπ Stop</button>
                </div>

                <div class="stat" style="margin-top: 20px;">
                    <span class="stat-label">
                        <span class="status-indicator" id="kafkaStatus"></span>
                        Kafka Broker
                    </span>
                    <span class="stat-value" id="kafkaStatusDetails">Checking...</span>
                </div>

                <div class="controls" style="margin-top: 20px;">
                    <button class="btn-secondary" onclick="exportData()">üóÇÔ∏è Export CSV</button>
                    <button class="btn-warning" onclick="clearData()">üóëÔ∏è Clear All Data</button>
                </div>
            </div>

            <!-- Configuration Card -->
            <div class="card">
                <h2>üîß Configuration</h2>

                <p class="card-intro">Tell the producer how long to run and how often to send readings. The dashboard calculates the total messages for you and keeps the last update visible below.</p>
                <label>Duration</label>
                <div class="input-group">
                    <div class="input-wrapper">
                        <span class="input-label">Hours</span>
                        <input type="number" id="durationHours" min="0" value="0">
                    </div>
                    <div class="input-wrapper">
                        <span class="input-label">Minutes</span>
                        <input type="number" id="durationMinutes" min="0" max="59" value="0">
                    </div>
                </div>

                <label>Interval</label>
                <div class="input-wrapper">
                    <span class="input-label">Seconds</span>
                    <input type="number" id="intervalSeconds" value="30">
                </div>

                <div class="controls">
                    <button class="btn-primary" onclick="updateConfig()">üíæ Update Config</button>
                    <button class="btn-secondary" onclick="resetConfig()">üîÑ Reset Defaults</button>
                </div>
                <div class="config-meta" id="configMessage">Ready for updates.</div>

                <div class="preset-container">
                    <div class="preset-title">‚ö° Quick Presets</div>
                    <div class="preset-buttons">
                        <button class="btn-primary" onclick="setQuickTest()">Quick Test</button>
                        <button class="btn-primary" onclick="setOneMin()">1 Minute</button>
                        <button class="btn-primary" onclick="setOneHour()">1 Hour</button>
                        <button class="btn-primary" onclick="setProduction()">24 Hours</button>
                    </div>
                </div>
            </div>

            <!-- Alerts Card -->
            <div class="card">
                <h2>üö® Alerts</h2>
                <p class="card-intro">Every anomaly, failure, or manual action is stored here in plain English. Use it as the event log when something looks off.</p>
                <div class="alert-list" id="alertList">
                    <div style="text-align: center; color: #94a3b8; padding: 20px;">
                        No alerts yet
                    </div>
                </div>
            </div>
        </div>

        <!-- ML Anomaly Detection Card -->
        <div class="card" style="margin-bottom: 24px;">
            <h2>ü§ñ ML Anomaly Detection</h2>
            <p class="card-intro">Isolation Forest model detects unusual patterns across all 50 sensor parameters. Click "Generate Report" to get AI-powered root cause analysis.</p>
            
            <!-- ML Stats -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px;">
                <div class="big-stat" style="padding: 20px;">
                    <div class="big-stat-value" id="mlTotalAnomalies" style="font-size: 36px;">0</div>
                    <div class="big-stat-label">Anomalies Detected</div>
                </div>
                <div class="big-stat" style="padding: 20px;">
                    <div class="big-stat-value" id="mlAnomalyRate" style="font-size: 36px;">0%</div>
                    <div class="big-stat-label">Recent Rate</div>
                </div>
                <div class="big-stat" style="padding: 20px;">
                    <div class="big-stat-value" id="mlReportsGenerated" style="font-size: 36px;">0</div>
                    <div class="big-stat-label">Reports Generated</div>
                </div>
            </div>
            
            <!-- Anomaly List -->
            <div class="anomaly-list" id="anomalyList" style="max-height: 400px; overflow-y: auto;">
                <div style="text-align: center; color: #94a3b8; padding: 40px;">
                    No ML anomalies detected yet. Start the pipeline to begin monitoring.
                </div>
            </div>
        </div>

        <!-- Report Modal -->
        <div id="reportModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìã Anomaly Analysis Report</h2>
                    <button class="modal-close" onclick="closeReportModal()">&times;</button>
                </div>
                <div class="modal-body" id="reportContent">
                    Loading...
                </div>
            </div>
        </div>

        <!-- 50 Parameters by Category -->
        <div class="card">
            <h2>üéØ All Sensor Parameters (50)</h2>
            <p class="card-intro">Grouped by category so you can see how the 50 different readings are trending without memorizing names. Toggle categories to focus on the ones you care about.</p>
            <div class="tabs" id="categoryTabs"></div>
            <div id="categoryContent"></div>
        </div>

        <!-- Readings History Card -->
        <div class="card">
            <h2>üì° Live Sensor Readings</h2>
            <p class="card-intro">A rolling timeline of raw values pulled straight from the database. Pick a category and skim the cards to spot jumps or dips.</p>
            <label>Select Category to Monitor</label>
            <select id="historyCategory" onchange="changeHistoryCategory()" style="width: 100%; padding: 14px; border-radius: 12px; background: rgba(15, 23, 42, 0.6); color: #e2e8f0; border: 1px solid rgba(148, 163, 184, 0.2); font-size: 15px; font-weight: 600; margin-bottom: 20px; cursor: pointer;">
                <option value="environmental">üåç Environmental Sensors</option>
                <option value="mechanical">‚öôÔ∏è Mechanical Sensors</option>
                <option value="thermal">üî• Thermal Sensors</option>
                <option value="electrical">‚ö° Electrical Sensors</option>
                <option value="fluid">üíß Fluid Dynamics Sensors</option>
            </select>
            <div class="history-container" id="readingsHistory"></div>
        </div>
    </div>

    <script>
        let selectedHistoryCategory = 'environmental';
        let configLimits = null;
        let configDefaults = null;

        // Map of sensors by category from config
        const sensorsByCategory = {
            'environmental': ['temperature', 'pressure', 'humidity', 'ambient_temp', 'dew_point', 'air_quality_index', 'co2_level', 'particle_count', 'noise_level', 'light_intensity'],
            'mechanical': ['vibration', 'rpm', 'torque', 'shaft_alignment', 'bearing_temp', 'motor_current', 'belt_tension', 'gear_wear', 'coupling_temp', 'lubrication_pressure'],
            'thermal': ['coolant_temp', 'exhaust_temp', 'oil_temp', 'radiator_temp', 'thermal_efficiency', 'heat_dissipation', 'inlet_temp', 'outlet_temp', 'core_temp', 'surface_temp'],
            'electrical': ['voltage', 'current', 'power_factor', 'frequency', 'resistance', 'capacitance', 'inductance', 'phase_angle', 'harmonic_distortion', 'ground_fault'],
            'fluid': ['flow_rate', 'fluid_pressure', 'viscosity', 'density', 'reynolds_number', 'pipe_pressure_drop', 'pump_efficiency', 'cavitation_index', 'turbulence', 'valve_position']
        };

        // Hidden sensors state tracking
        let hiddenSensors = new Set();

        // Load hidden sensors from localStorage on page load
        function loadHiddenSensors() {
            try {
                const stored = localStorage.getItem('hiddenSensors');
                if (stored) {
                    hiddenSensors = new Set(JSON.parse(stored));
                }
            } catch (e) {
                console.error('Failed to load hidden sensors:', e);
            }
        }

        // Save hidden sensors to localStorage
        function saveHiddenSensors() {
            try {
                localStorage.setItem('hiddenSensors', JSON.stringify([...hiddenSensors]));
            } catch (e) {
                console.error('Failed to save hidden sensors:', e);
            }
        }

        // Toggle sensor visibility
        function toggleSensor(sensorName) {
            if (hiddenSensors.has(sensorName)) {
                hiddenSensors.delete(sensorName);
            } else {
                hiddenSensors.add(sensorName);
            }
            saveHiddenSensors();
            updateStats();
        }

        function changeHistoryCategory() {
            selectedHistoryCategory = document.getElementById('historyCategory').value;
            updateStats();
        }

        function formatNumber(value, decimals = 2) {
            if (value === null || value === undefined || isNaN(value)) {
                return '--';
            }
            return Number(value).toFixed(decimals);
        }

        function formatDateTime(value) {
            if (!value) return '';
            const date = new Date(value);
            return isNaN(date.getTime()) ? value : date.toLocaleString();
        }

        let activeCategory = 'environmental';
        let activeStatsCategory = 'environmental';
        const categoryIcons = {
            'environmental': 'üåç',
            'mechanical': '‚öôÔ∏è',
            'thermal': 'üî•',
            'electrical': '‚ö°',
            'fluid': 'üíß'
        };

        function switchCategory(category) {
            activeCategory = category;
            // Update tab UI for All Sensor Parameters
            document.querySelectorAll('#categoryTabs .tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.category === category);
            });
            // Update content UI for All Sensor Parameters
            document.querySelectorAll('#categoryContent .tab-content').forEach(content => {
                content.classList.toggle('active', content.dataset.category === category);
            });
        }

        function switchStatsCategory(category) {
            activeStatsCategory = category;
            // Update tab UI for Statistics
            document.querySelectorAll('#statsCategoryTabs .tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.category === category);
            });
            // Update content UI for Statistics
            document.querySelectorAll('#statsCategoryContent .tab-content').forEach(content => {
                content.classList.toggle('active', content.dataset.category === category);
            });
        }

        function updateStats() {
            fetch('/api/stats')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('totalCount').textContent = data.total_count || 0;

                    // Update Statistics section with category tabs
                    if (data.stats_by_category) {
                        const statsTabsEl = document.getElementById('statsCategoryTabs');
                        const statsContentEl = document.getElementById('statsCategoryContent');

                        if (statsTabsEl && !statsTabsEl.hasChildNodes()) {
                            // Build tabs for Statistics (only once)
                            const categories = Object.keys(data.stats_by_category);
                            statsTabsEl.innerHTML = categories.map(cat => {
                                const catData = data.stats_by_category[cat];
                                const icon = categoryIcons[cat] || 'üìä';
                                const isActive = cat === activeStatsCategory ? 'active' : '';
                                return `<div class="tab ${isActive}" data-category="${cat}" onclick="switchStatsCategory('${cat}')">${icon} ${catData.name}</div>`;
                            }).join('');
                        }

                        if (statsContentEl) {
                            // Build content for Statistics categories
                            const categories = Object.keys(data.stats_by_category);
                            statsContentEl.innerHTML = categories.map(cat => {
                                const catData = data.stats_by_category[cat];
                                const isActive = cat === activeStatsCategory ? 'active' : '';

                                // Filter out hidden sensors
                                const visibleSensors = Object.entries(catData.sensors)
                                    .filter(([name, info]) => !hiddenSensors.has(name));

                                const statsHtml = visibleSensors.map(([name, info]) => {
                                    const displayName = name.replace(/_/g, ' ').toUpperCase();
                                    const value = info.value !== null && info.value !== undefined ? formatNumber(info.value) : '--';
                                    return `
                                        <div class="stat">
                                            <span class="stat-label">${displayName}</span>
                                            <span class="stat-value">${value}${info.unit ? ' ' + info.unit : ''}</span>
                                        </div>
                                    `;
                                }).join('');

                                return `
                                    <div class="tab-content ${isActive}" data-category="${cat}">
                                        ${statsHtml || '<div class="stat"><span class="stat-label">No visible sensors</span></div>'}
                                    </div>
                                `;
                            }).join('');
                        }
                    }

                    // Update categorized sensor data for All Sensor Parameters section
                    if (data.stats_by_category) {
                        const tabsEl = document.getElementById('categoryTabs');
                        const contentEl = document.getElementById('categoryContent');

                        if (tabsEl && !tabsEl.hasChildNodes()) {
                            // Build tabs (only once)
                            const categories = Object.keys(data.stats_by_category);
                            tabsEl.innerHTML = categories.map(cat => {
                                const catData = data.stats_by_category[cat];
                                const icon = categoryIcons[cat] || 'üìä';
                                const isActive = cat === activeCategory ? 'active' : '';
                                return `<div class="tab ${isActive}" data-category="${cat}" onclick="switchCategory('${cat}')">${icon} ${catData.name}</div>`;
                            }).join('');
                        }

                        if (contentEl) {
                            // Build content for all categories
                            const categories = Object.keys(data.stats_by_category);
                            contentEl.innerHTML = categories.map(cat => {
                                const catData = data.stats_by_category[cat];
                                const isActive = cat === activeCategory ? 'active' : '';
                                const sensorsHtml = Object.entries(catData.sensors).map(([name, info]) => {
                                    const displayName = name.replace(/_/g, ' ').toUpperCase();
                                    const value = info.value !== null && info.value !== undefined ? formatNumber(info.value) : '--';
                                    const isHidden = hiddenSensors.has(name);
                                    const hiddenClass = isHidden ? 'hidden-sensor' : '';
                                    const checkedAttr = isHidden ? '' : 'checked';
                                    return `
                                        <div class="sensor-item ${hiddenClass}" data-sensor="${name}">
                                            <input type="checkbox" class="sensor-toggle" ${checkedAttr} onchange="toggleSensor('${name}')" title="Toggle visibility">
                                            <div class="sensor-name">${displayName}</div>
                                            <div class="sensor-value">${value}<span class="sensor-unit">${info.unit}</span></div>
                                        </div>
                                    `;
                                }).join('');

                                return `
                                    <div class="tab-content ${isActive}" data-category="${cat}">
                                        <div class="sensor-grid">${sensorsHtml}</div>
                                    </div>
                                `;
                            }).join('');
                        }
                    }

                    // Render history for selected category
                    if (data.recent_readings_full && data.recent_readings_full.length > 0) {
                        const sensors = sensorsByCategory[selectedHistoryCategory] || [];
                        const sensorUnits = data.stats_by_category?.[selectedHistoryCategory]?.sensors || {};

                        const historyHTML = data.recent_readings_full.map(reading => {
                            const metricsHtml = sensors
                                .filter(sensor => !hiddenSensors.has(sensor)) // Filter out hidden sensors
                                .map(sensor => {
                                    const displayName = sensor.replace(/_/g, ' ').toUpperCase();
                                    const value = reading[sensor];
                                    const unit = sensorUnits[sensor]?.unit || '';
                                    return `
                                        <div class="history-metric">
                                            <div class="metric-value">${formatNumber(value)}${unit ? '<span class="sensor-unit">' + unit + '</span>' : ''}</div>
                                            <div class="metric-label">${displayName}</div>
                                        </div>
                                    `;
                                }).join('');

                            return `
                                <div class="history-item">
                                    <div class="history-timestamp">${formatDateTime(reading.created_at)}</div>
                                    <div class="history-grid">${metricsHtml}</div>
                                </div>
                            `;
                        }).join('');
                        document.getElementById('readingsHistory').innerHTML = historyHTML;
                    } else {
                        document.getElementById('readingsHistory').innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 40px; font-size: 14px; text-transform: uppercase; letter-spacing: 2px;">No data yet</div>';
                    }
                });
        }

        function updateStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    const producerEl = document.getElementById('producerStatus');
                    const consumerEl = document.getElementById('consumerStatus');
                    if (producerEl) {
                        producerEl.className = 'status-indicator ' + (data.producer_running ? 'status-running' : 'status-stopped');
                    }
                    if (consumerEl) {
                        consumerEl.className = 'status-indicator ' + (data.consumer_running ? 'status-running' : 'status-stopped');
                    }

                    if (data.kafka) {
                        const kafkaIndicator = document.getElementById('kafkaStatus');
                        const kafkaDetails = document.getElementById('kafkaStatusDetails');
                        if (kafkaIndicator) {
                            let className = 'status-indicator ';
                            if (data.kafka.status === 'healthy') {
                                className += 'status-running';
                            } else if (data.kafka.status === 'unhealthy') {
                                className += 'status-stopped';
                            }
                            kafkaIndicator.className = className;
                        }
                        if (kafkaDetails) {
                            if (data.kafka.status === 'healthy') {
                                kafkaDetails.textContent = data.kafka.latency_ms ? `OK (${data.kafka.latency_ms} ms)` : 'OK';
                            } else if (data.kafka.status === 'unhealthy') {
                                kafkaDetails.textContent = data.kafka.error || 'Unreachable';
                            } else {
                                kafkaDetails.textContent = 'Checking...';
                            }
                        }
                    }
                });
        }

        function loadConfig() {
            fetch('/api/config')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('durationHours').value = data.duration_hours ?? 0;
                    document.getElementById('durationMinutes').value = data.duration_minutes ?? 0;
                    document.getElementById('intervalSeconds').value = data.interval_seconds ?? 5;
                    configLimits = data.limits || null;
                    configDefaults = data.defaults || null;
                    if (configLimits) {
                        const intervalInput = document.getElementById('intervalSeconds');
                        intervalInput.min = configLimits.interval_seconds?.min ?? 1;
                        intervalInput.max = configLimits.interval_seconds?.max ?? 3600;
                    }
                    displayConfigMessage('Ready for updates.');
                });
        }

        function displayConfigMessage(message, isError = false) {
            const el = document.getElementById('configMessage');
            if (!el) return;
            el.textContent = message;
            el.style.color = isError ? '#f87171' : '#34d399';
        }

        function updateConfig() {
            const payload = {
                duration_hours: parseInt(document.getElementById('durationHours').value, 10),
                duration_minutes: parseInt(document.getElementById('durationMinutes').value, 10),
                interval_seconds: parseInt(document.getElementById('intervalSeconds').value, 10)
            };

            fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    displayConfigMessage('Configuration updated!', false);
                    loadConfig();
                } else {
                    displayConfigMessage(result.error || 'Failed to update config', true);
                }
            })
            .catch(() => displayConfigMessage('Failed to update config', true));
        }

        function resetConfig() {
            fetch('/api/config/reset', { method: 'POST' })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        displayConfigMessage('Reset to defaults.', false);
                        loadConfig();
                    } else {
                        displayConfigMessage(result.error || 'Failed to reset config', true);
                    }
                })
                .catch(() => displayConfigMessage('Failed to reset config', true));
        }

        function exportData(limit = 500) {
            window.open(`/api/export?limit=${limit}`, '_blank');
        }

        function startComponent(component) {
            fetch(`/api/start/${component}`)
                .then(r => r.json())
                .then(result => {
                    alert(result.success ? `‚úÖ ${component} started!` : `‚ùå Failed: ${result.error}`);
                    updateStatus();
                });
        }

        function stopComponent(component) {
            fetch(`/api/stop/${component}`)
                .then(r => r.json())
                .then(result => {
                    alert(result.success ? `‚úÖ ${component} stopped!` : `‚ùå Failed: ${result.error}`);
                    updateStatus();
                });
        }

        function clearData() {
            if (confirm('üóëÔ∏è Clear all sensor data from database?')) {
                fetch('/api/clear_data')
                    .then(r => r.json())
                    .then(result => {
                        alert(result.success ? '‚úÖ Data cleared!' : '‚ùå Failed to clear data');
                        updateStats();
                    });
            }
        }

        function loadAlerts() {
            fetch('/api/alerts?limit=20')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('alertList');
                    if (!container) return;

                    const alerts = data.alerts || [];
                    if (alerts.length === 0) {
                        container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px;">No alerts yet</div>';
                        return;
                    }

                    container.innerHTML = alerts.map(alert => {
                        const severity = (alert.severity || 'info').toLowerCase();
                        return `
                            <div class="alert-item">
                                <div>
                                    <div class="alert-type">${alert.alert_type}</div>
                                    <div class="alert-message">${alert.message}</div>
                                </div>
                                <div class="alert-meta">
                                    <span class="alert-badge ${severity}">${alert.severity}</span>
                                    <div class="alert-time">${formatDateTime(alert.created_at)}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                });
        }

        function setQuickTest() {
            document.getElementById('durationHours').value = 0;
            document.getElementById('durationMinutes').value = 2;
            document.getElementById('intervalSeconds').value = 10;
        }

        function setOneMin() {
            document.getElementById('durationHours').value = 0;
            document.getElementById('durationMinutes').value = 1;
            document.getElementById('intervalSeconds').value = 5;
        }

        function setOneHour() {
            document.getElementById('durationHours').value = 1;
            document.getElementById('durationMinutes').value = 0;
            document.getElementById('intervalSeconds').value = 30;
        }

        function setProduction() {
            document.getElementById('durationHours').value = 24;
            document.getElementById('durationMinutes').value = 0;
            document.getElementById('intervalSeconds').value = 30;
        }

        // ========== ML Anomaly Detection Functions ==========
        
        function loadMLStats() {
            fetch('/api/ml-stats')
                .then(r => r.json())
                .then(data => {
                    if (data.error) return;
                    
                    document.getElementById('mlTotalAnomalies').textContent = data.total_anomalies || 0;
                    document.getElementById('mlAnomalyRate').textContent = (data.recent_anomaly_rate || 0).toFixed(1) + '%';
                    document.getElementById('mlReportsGenerated').textContent = data.completed_reports || 0;
                })
                .catch(() => {});
        }
        
        function loadAnomalies() {
            fetch('/api/anomalies?limit=20&only_anomalies=true')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('anomalyList');
                    if (!container) return;
                    
                    const anomalies = data.anomalies || [];
                    if (anomalies.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; color: #94a3b8; padding: 40px;">
                                No ML anomalies detected yet. Start the pipeline to begin monitoring.
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = anomalies.map(anomaly => {
                        const sensors = anomaly.detected_sensors || [];
                        const sensorTags = sensors.slice(0, 5).map(s => 
                            `<span>${s.replace(/_/g, ' ')}</span>`
                        ).join('');
                        const moreSensors = sensors.length > 5 ? `<span>+${sensors.length - 5} more</span>` : '';
                        
                        let actionBtn = '';
                        if (anomaly.report_id && anomaly.report_status === 'completed') {
                            actionBtn = `
                                <button class="btn-report btn-view-report" onclick="viewReport(${anomaly.report_id})">
                                    üìÑ View Report
                                </button>
                            `;
                        } else if (anomaly.report_status === 'generating') {
                            actionBtn = `
                                <button class="btn-report" disabled>
                                    <span class="loading-spinner"></span> Generating...
                                </button>
                            `;
                        } else {
                            actionBtn = `
                                <button class="btn-report" onclick="generateReport(${anomaly.id}, this)">
                                    ü§ñ Generate Report
                                </button>
                            `;
                        }
                        
                        return `
                            <div class="anomaly-item">
                                <div class="anomaly-info">
                                    <div class="anomaly-header">
                                        <span class="anomaly-score">Score: ${anomaly.anomaly_score.toFixed(4)}</span>
                                        <span class="anomaly-method">${anomaly.detection_method}</span>
                                    </div>
                                    <div class="anomaly-timestamp">${formatDateTime(anomaly.created_at)}</div>
                                    <div class="anomaly-sensors">
                                        <strong>Contributing sensors:</strong><br>
                                        ${sensorTags}${moreSensors}
                                    </div>
                                </div>
                                <div class="anomaly-actions">
                                    ${actionBtn}
                                </div>
                            </div>
                        `;
                    }).join('');
                })
                .catch(() => {});
        }
        
        function generateReport(anomalyId, button) {
            if (button) {
                button.disabled = true;
                button.innerHTML = '<span class="loading-spinner"></span> Generating...';
            }
            
            fetch(`/api/generate-report/${anomalyId}`, { method: 'POST' })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        alert('‚úÖ Report generated successfully!');
                        loadAnomalies();
                        loadMLStats();
                        viewReport(result.report_id);
                    } else {
                        alert('‚ùå Failed to generate report: ' + (result.error || 'Unknown error'));
                        if (button) {
                            button.disabled = false;
                            button.innerHTML = 'ü§ñ Generate Report';
                        }
                    }
                })
                .catch(err => {
                    alert('‚ùå Error generating report');
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = 'ü§ñ Generate Report';
                    }
                });
        }
        
        function viewReport(reportId) {
            const modal = document.getElementById('reportModal');
            const content = document.getElementById('reportContent');
            
            modal.style.display = 'flex';
            content.innerHTML = '<div style="text-align: center; padding: 40px;"><span class="loading-spinner" style="width: 40px; height: 40px; border-width: 3px;"></span><p style="margin-top: 16px;">Loading report...</p></div>';
            
            fetch(`/api/reports/${reportId}`)
                .then(r => r.json())
                .then(report => {
                    if (report.error) {
                        content.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 40px;">${report.error}</div>`;
                        return;
                    }
                    
                    // Format the report
                    const analysis = report.chatgpt_analysis || 'No analysis available';
                    
                    content.innerHTML = `
                        <div class="report-meta">
                            <div class="report-meta-item">
                                <div class="report-meta-label">Report ID</div>
                                <div class="report-meta-value">#${report.id}</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Anomaly ID</div>
                                <div class="report-meta-value">#${report.anomaly_id}</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Generated</div>
                                <div class="report-meta-value">${formatDateTime(report.completed_at || report.created_at)}</div>
                            </div>
                            <div class="report-meta-item">
                                <div class="report-meta-label">Status</div>
                                <div class="report-meta-value" style="color: ${report.status === 'completed' ? '#10b981' : '#f59e0b'}">${report.status.toUpperCase()}</div>
                            </div>
                        </div>
                        <div class="report-analysis">
                            ${formatMarkdown(analysis)}
                        </div>
                    `;
                })
                .catch(err => {
                    content.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 40px;">Failed to load report</div>`;
                });
        }
        
        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }
        
        // Close modal on escape key or clicking outside
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeReportModal();
        });
        
        document.getElementById('reportModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeReportModal();
        });
        
        // Simple markdown formatter
        function formatMarkdown(text) {
            if (!text) return '';
            
            // Escape HTML
            text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Headers
            text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.*$)/gm, '<h3 style="font-size: 18px;">$1</h3>');
            text = text.replace(/^# (.*$)/gm, '<h3 style="font-size: 20px;">$1</h3>');
            
            // Bold
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Italic
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Lists
            text = text.replace(/^- (.*$)/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            
            // Numbered lists
            text = text.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
            
            // Line breaks
            text = text.replace(/\n\n/g, '</p><p>');
            text = text.replace(/\n/g, '<br>');
            
            return '<p>' + text + '</p>';
        }

        // Auto-refresh every 2 seconds
        setInterval(() => {
            updateStats();
            updateStatus();
            loadAlerts();
            loadMLStats();
            loadAnomalies();
        }, 2000);

        // Initial load
        loadHiddenSensors();
        updateStats();
        updateStatus();
        loadConfig();
        loadAlerts();
        loadMLStats();
        loadAnomalies();
    </script>
</body>
</html>
